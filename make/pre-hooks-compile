#!/bin/sh

set -e
#set -x


if [ -d deps ]
then
        DEPS=deps
elif [ -d ../../deps ]
then
        DEPS=../../deps
else
        echo "can't find 'deps' directory around `pwd`" 1>&2
        exit 1
fi


ARCH_SUFFIX="`uname -s`-`uname -m`"
BINDIR=priv/bin-$ARCH_SUFFIX


if [ ! -x $BINDIR/piqi -o ! -x $BINDIR/piqic ]
then
    # build Piqi
    cd $DEPS/piqi_src
    . ./setenv.sh
    make distclean
    make deps
    make
    cd -

    # install the binaries
    mkdir -p $BINDIR

    cp $DEPS/piqi_src/piqic/piqic $BINDIR/piqic
    strip $BINDIR/piqic

    cp $DEPS/piqi_src/piqi-tools/piqi $BINDIR/piqi
    strip $BINDIR/piqi
fi

